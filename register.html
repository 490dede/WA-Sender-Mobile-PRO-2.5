<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Akun Baru - WA-Sender PRO 2.5</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; }
        .input-group:focus-within label { color: #6366F1; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

    <div class="max-w-md w-full bg-white rounded-[3rem] shadow-xl border border-slate-100 p-10">
        <header class="text-center mb-10">
            <h1 class="text-2xl font-black text-slate-900">Bergabung Sekarang</h1>
            <p class="text-sm font-bold text-slate-400 mt-2 uppercase tracking-widest">Dapatkan Akses Akun TRIAL Gratis</p>
        </header>

        <form id="regForm" class="space-y-5">
            <input type="hidden" id="userCountry" value="Unknown">
            <input type="hidden" id="userCurrency" value="USD">

            <div class="input-group">
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Username</label>
                <input type="text" id="regUsername" required placeholder="pilih_username" 
                    class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-bold mt-1">
            </div>

            <div class="input-group">
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Email Resmi</label>
                <input type="email" id="regEmail" required placeholder="anda@email.com" 
                    class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-bold mt-1">
            </div>

            <div class="input-group">
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">WhatsApp (Gunakan 62...)</label>
                <input type="text" id="regWA" required placeholder="62812345678" 
                    class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-bold mt-1">
            </div>

            <div class="input-group">
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Password</label>
                <input type="password" id="regPass" required placeholder="••••••••" 
                    class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-bold mt-1">
            </div>

            <button type="submit" id="btnReg" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl active:scale-95 transition-all mt-4">
                Buat Akun TRIAL Gratis
            </button>
        </form>

        <footer class="mt-8 text-center">
            <p class="text-xs font-bold text-slate-400">Sudah punya akun? 
                <a href="login.html" class="text-indigo-600 underline">Masuk di sini</a>
            </p>
        </footer>
    </div>

    <script>
        const SB_URL = "https://drdilgeztsubyukexpas.supabase.co";
        const SB_KEY = "sb_publishable_7SV_sRVw9ePVjXjYHQA4_A_P42uGzWo";
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        // --- 1. DETEKSI LOKASI & WILAYAH ---
        async function detectLocation() {
            try {
                const res = await fetch('http://ip-api.com/json/');
                const data = await res.json();
                document.getElementById('userCountry').value = data.countryCode; // ID, US, DE, dll
                
                // Set Mata Uang Default
                if(data.countryCode === 'ID') {
                    document.getElementById('userCurrency').value = 'IDR';
                } else if(['AT','BE','CY','EE','FI','FR','DE','GR','IE','IT','LV','LT','LU','MT','NL','PT','SK','SI','ES'].includes(data.countryCode)) {
                    document.getElementById('userCurrency').value = 'EUR';
                } else {
                    document.getElementById('userCurrency').value = 'USD';
                }
                console.log("Lokasi Terdeteksi:", data.countryCode);
            } catch (err) {
                console.log("Gagal deteksi lokasi, menggunakan default USD");
            }
        }
        detectLocation();

        // --- 2. LOGIKA PENDAFTARAN & ANTI-DUPLIKASI ---
        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnReg');
            const user = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const wa = document.getElementById('regWA').value;
            const pass = document.getElementById('regPass').value;
            const country = document.getElementById('userCountry').value;

            btn.disabled = true;
            btn.innerText = "MENGECEK DATA...";

            // Cek Duplikasi di Tabel Profiles
            const { data: exist } = await supabase
                .from('profiles')
                .select('username, email, whatsapp_number')
                .or(`username.eq.${user},email.eq.${email},whatsapp_number.eq.${wa}`);

            if (exist && exist.length > 0) {
                alert("Pendaftaran Gagal: Username, Email, atau WhatsApp sudah terdaftar!");
                btn.disabled = false;
                btn.innerText = "Buat Akun TRIAL Gratis";
                return;
            }

            // Eksekusi Auth Supabase
            btn.innerText = "MENCIPTAKAN AKUN...";
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email: email,
                password: pass,
                options: { data: { username: user } }
            });

            if (authError) {
                alert("Auth Error: " + authError.message);
                btn.disabled = false;
                return;
            }

            // Simpan ke Tabel Profiles (Otomatis TRIAL)
            const { error: profError } = await supabase.from('profiles').insert([{
                id: authData.user.id,
                username: user,
                email: email,
                whatsapp_number: wa,
                package_type: 'TRIAL',
                role: 'USER',
                country_origin: country
            }]);

            if (!profError) {
                alert("Registrasi Berhasil! Silakan cek email untuk verifikasi atau langsung login.");
                window.location.href = 'login.html';
            } else {
                alert("Database Error: " + profError.message);
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
