<script>
    const SB_URL = "https://xitvmryrzeiinlcgdrfj.supabase.co";
    const SB_KEY = "sb_publishable_DLbeS1UUi5tjY51yRy6VkA_unJMJFbk";
    const supabase = window.supabase.createClient(SB_URL, SB_KEY);

    async function initDashboard() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = 'index.html'; return; }

        const { data: profile, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', session.user.id)
            .single();

        if (!error && profile) {
            document.getElementById('display-name').innerText = profile.username || profile.full_name || 'MASTER';
            
            const tier = profile.package_type || 'TRIAL';
            const tierEl = document.getElementById('display-tier');
            tierEl.innerText = tier.toUpperCase() + " ACCOUNT";
            
            const upgradeCard = document.getElementById('upgrade-card');
            const upgradeTitle = document.getElementById('upgrade-title');

            // LOGIKA DINAMIS TOMBOL UPGRADE/MANAGE
            if(tier === 'MULTI') {
                tierEl.classList.add('text-purple-400');
                upgradeCard.classList.replace('from-indigo-600', 'from-purple-600');
                upgradeTitle.innerText = "Manage Team";
                // Mengubah fungsi klik dari upgrade ke manajemen CS
                upgradeCard.setAttribute('onclick', "location.href='manajemen-cs.html'");
            } else if(tier === 'PRO') {
                tierEl.classList.add('text-emerald-400');
                upgradeCard.classList.replace('from-indigo-600', 'from-emerald-600');
                upgradeTitle.innerText = "Pro Active";
                upgradeCard.setAttribute('onclick', "alert('Your PRO status is active!')");
            } else {
                // Default untuk TRIAL
                upgradeCard.setAttribute('onclick', "location.href='upgrade.html'");
            }

            if(profile.avatar_url) {
                const avatarImg = document.getElementById('user-avatar-mini');
                avatarImg.src = profile.avatar_url;
                avatarImg.classList.remove('hidden');
                document.getElementById('user-icon-placeholder').classList.add('hidden');
            }
            
            const sent = profile.messages_sent || 0;
            animateValue("stats-sent", 0, sent, 1500);
        }
    }

    function animateValue(id, start, end, duration, suffix = "") {
        const obj = document.getElementById(id);
        if(!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString() + suffix;
            if (progress < 1) { window.requestAnimationFrame(step); }
        };
        window.requestAnimationFrame(step);
    }

    async function handleLogout() {
        const { error } = await supabase.auth.signOut();
        if(!error) window.location.replace('index.html');
    }

    async function handleDeleteAccount() {
        if (confirm("WARNING: Hapus akun secara permanen?")) {
            const { data: { session } } = await supabase.auth.getSession();
            const { error } = await supabase.from('profiles').delete().eq('id', session.user.id);
            if (!error) {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            }
        }
    }

    initDashboard();
</script>
