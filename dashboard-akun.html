<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Profile - WA-Sender PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0F172A; color: #F1F5F9; }
        
        /* DARK THEME GLASS CARD - Sesuai request (Slate-700/45) */
        .glass-card { 
            background: rgba(51, 65, 85, 0.45); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.15); 
        }
        
        .text-sharp { text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        input::placeholder { color: #64748b; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto flex justify-between items-center mb-10">
        <a id="backBtn" href="dashboard-user.html" class="px-5 py-2.5 bg-slate-800 border border-white/10 rounded-2xl text-[10px] font-black uppercase italic shadow-lg active:scale-95 transition-all text-white">
            <i class="fa-solid fa-arrow-left mr-2 text-indigo-400"></i> Kembali
        </a>
        <h2 class="text-[11px] font-black italic uppercase text-slate-400 tracking-[0.3em]">Profile Identity System</h2>
    </div>

    <div class="max-w-4xl mx-auto space-y-6">
        <div id="viewModeBadge" class="hidden bg-indigo-600/20 border border-indigo-500/50 text-indigo-400 text-[10px] font-black uppercase p-4 text-center rounded-[2rem] italic shadow-2xl animate-pulse">
            <i class="fa-solid fa-shield-halved mr-2"></i> Administrator View Mode: Data is Read-Only
        </div>
        
        <div class="glass-card rounded-[3rem] p-8 shadow-2xl flex flex-col md:flex-row items-center gap-8 relative overflow-hidden">
            <div id="avatarBox" onclick="document.getElementById('fileInput').click()" class="w-36 h-36 bg-slate-900 rounded-[2.5rem] flex items-center justify-center text-white text-5xl font-black cursor-pointer hover:scale-105 transition-all relative group overflow-hidden border-4 border-indigo-500/20 shadow-2xl">
                <span id="initials" class="text-sharp">...</span>
                <img id="avatarImg" class="w-full h-full object-cover hidden" alt="Avatar">
                <div id="cameraOverlay" class="absolute inset-0 bg-indigo-600/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all">
                    <i class="fa-solid fa-camera text-2xl text-white"></i>
                </div>
            </div>
            <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="uploadAvatar(this)">

            <div class="text-center md:text-left flex-1">
                <h1 id="displayUsername" class="text-5xl font-black italic text-white leading-none tracking-tighter text-sharp">...</h1>
                <p id="displayEmail" class="text-sm font-bold text-slate-400 mt-3 uppercase tracking-widest leading-none">...</p>
                <div class="mt-5 inline-block px-5 py-2 bg-indigo-500/20 text-indigo-400 border border-indigo-500/30 rounded-xl text-[10px] font-black italic uppercase shadow-sm" id="badgeStatus">
                    LOADING...
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-card p-7 rounded-[2.5rem]">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 ml-2 italic">WhatsApp Number</label>
                <div class="flex gap-3">
                    <input type="text" id="inputWA" class="flex-1 p-4 bg-slate-900/50 border border-white/10 rounded-2xl outline-none font-black text-white focus:ring-2 ring-indigo-500 shadow-inner" placeholder="628123...">
                    <button id="saveWA" onclick="updateWA()" class="px-6 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-indigo-600/20 active:scale-95 transition-all italic">Save</button>
                </div>
            </div>
            <div class="glass-card p-7 rounded-[2.5rem]">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 ml-2 italic">Subscription Expiry</label>
                <div id="displayExpiry" class="p-4 bg-slate-900/50 border border-white/10 rounded-2xl font-black text-emerald-400 italic shadow-inner">...</div>
            </div>
        </div>

        <div id="promoBanner" class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-[3rem] p-10 text-white flex flex-col md:flex-row items-center justify-between gap-8 shadow-2xl relative overflow-hidden">
            <div class="z-10">
                <h3 class="text-3xl font-black italic uppercase leading-none mb-2 tracking-tighter">Level Up to PRO</h3>
                <p class="text-[11px] font-bold text-indigo-100 uppercase tracking-[0.2em] opacity-80">Access Unlimited Automation & Priority Support</p>
            </div>
            <a href="upgrade.html" class="z-10 px-12 py-5 bg-white text-indigo-600 rounded-[2rem] font-black text-[12px] uppercase shadow-2xl hover:scale-105 transition-all active:scale-95 leading-tight text-center">
                Upgrade Now
            </a>
            <i class="fa-solid fa-crown absolute right-[-20px] bottom-[-20px] text-[150px] text-white/10 rotate-12"></i>
        </div>
    </div>

    <script>
        const SB_URL = "https://xitvmryrzeiinlcgdrfj.supabase.co";
        const SB_KEY = "sb_publishable_DLbeS1UUi5tjY51yRy6VkA_unJMJFbk";
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);
        let currentUser = null;

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if(!session) return window.location.href = 'login.html';

            const urlParams = new URLSearchParams(window.location.search);
            const isViewMode = urlParams.get('mode') === 'view';
            const targetId = isViewMode ? sessionStorage.getItem('view_as_user_id') : session.user.id;

            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', targetId)
                .maybeSingle();

            if(profile) {
                currentUser = profile;
                document.getElementById('displayUsername').innerText = profile.username || 'Anonymous';
                document.getElementById('displayEmail').innerText = profile.email || '-';
                document.getElementById('inputWA').value = profile.whatsapp_number || '';
                document.getElementById('badgeStatus').innerText = (profile.package_type || 'TRIAL') + " LEVEL ACCOUNT";

                const initials = document.getElementById('initials');
                const avatarImg = document.getElementById('avatarImg');
                if(profile.avatar_url) {
                    avatarImg.src = profile.avatar_url;
                    avatarImg.classList.remove('hidden');
                    initials.classList.add('hidden');
                } else {
                    initials.innerText = (profile.username || 'WA').substring(0,2).toUpperCase();
                    initials.classList.remove('hidden');
                    avatarImg.classList.add('hidden');
                }

                if(profile.expired_at) {
                    const date = new Date(profile.expired_at);
                    document.getElementById('displayExpiry').innerText = date.toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });
                }

                if (isViewMode) {
                    document.getElementById('viewModeBadge').classList.remove('hidden');
                    document.getElementById('backBtn').href = 'admin490-master-panel.html';
                    document.getElementById('saveWA').style.display = 'none';
                    document.getElementById('inputWA').readOnly = true;
                    document.getElementById('avatarBox').onclick = null;
                    document.getElementById('avatarBox').style.cursor = 'default';
                    if(document.getElementById('cameraOverlay')) document.getElementById('cameraOverlay').remove();
                    document.getElementById('promoBanner').style.display = 'none';
                }
            }
        }

        async function updateWA() {
            const newWA = document.getElementById('inputWA').value;
            const { error } = await supabase.from('profiles').update({ whatsapp_number: newWA }).eq('id', currentUser.id);
            if(error) alert("Error: " + error.message);
            else alert("WhatsApp Number Updated!");
        }

        async function uploadAvatar(input) {
            if (!input.files || input.files.length === 0) return;
            const file = input.files[0];
            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}.${fileExt}`;
            document.getElementById('initials').innerText = "‚è≥";

            try {
                const { error: uploadError } = await supabase.storage.from('avatars').upload(fileName, file, { upsert: true });
                if (uploadError) throw uploadError;
                const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(fileName);
                await supabase.from('profiles').update({ avatar_url: publicUrl }).eq('id', currentUser.id);
                location.reload();
            } catch (err) {
                alert("Upload Failed: " + err.message);
                init();
            }
        }

        init();
    </script>
</body>
</html>
