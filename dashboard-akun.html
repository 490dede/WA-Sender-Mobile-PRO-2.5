<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Akun - WA-Sender PRO 2.5</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; color: #1E293B; }
        .card-custom { background: white; border-radius: 3rem; border: 1px solid #F1F5F9; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.02); }
        .input-field { background: #F8FAFC; border: 1px solid #F1F5F9; border-radius: 1.5rem; padding: 1.25rem; font-weight: 700; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #6366F1; background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.05); }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-5xl mx-auto space-y-8">
        
        <header class="bg-white p-8 rounded-[2.5rem] flex justify-between items-center border border-slate-100 shadow-sm">
            <div>
                <h1 class="text-2xl font-black text-slate-900 tracking-tight">WA-Sender PRO 2.5</h1>
                <div class="mt-2">
                    <span id="statusBadge" class="px-4 py-1.5 bg-slate-100 text-slate-400 text-[10px] font-black rounded-full uppercase tracking-widest italic">Memvalidasi...</span>
                </div>
            </div>
            <a href="delivery-chat.html" class="w-14 h-14 bg-slate-900 text-white rounded-[1.5rem] flex items-center justify-center text-2xl hover:scale-105 transition-all shadow-xl shadow-slate-200">üè†</a>
        </header>

        <section class="card-custom p-10 md:p-14">
            <h3 class="font-black text-slate-900 mb-10 uppercase tracking-[0.2em] text-sm italic">Informasi Akun</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-3">
                    <label class="text-[11px] font-black text-slate-400 uppercase ml-2 tracking-widest">Username</label>
                    <input type="text" id="username" placeholder="Masukkan Username" class="w-full input-field text-slate-700">
                </div>
                <div class="space-y-3">
                    <label class="text-[11px] font-black text-slate-400 uppercase ml-2 tracking-widest">Email (Terkunci)</label>
                    <input type="text" id="displayEmail" disabled class="w-full input-field bg-slate-50 text-slate-400 cursor-not-allowed border-dashed">
                </div>
            </div>
            <button onclick="updateProfile()" id="btnUpdate" class="mt-10 px-12 py-5 bg-[#0F172A] text-white rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-black transition-all shadow-2xl active:scale-95">
                Simpan Profil
            </button>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div onclick="selectPlan('PRO')" class="bg-white p-10 rounded-[3rem] border-2 border-transparent hover:border-indigo-500 transition-all cursor-pointer shadow-sm group">
                <h4 class="font-black text-slate-900 text-xl group-hover:text-indigo-600">Paket PRO</h4>
                <p class="text-[10px] font-bold text-slate-400 uppercase mt-1">Single User / Perorangan</p>
                <div class="mt-8 flex items-baseline gap-1">
                    <span class="text-3xl font-black text-indigo-600">Rp 150.000</span>
                    <span class="text-xs font-bold text-slate-400">/bulan</span>
                </div>
            </div>
            <div onclick="selectPlan('MULTI')" class="bg-white p-10 rounded-[3rem] border-2 border-transparent hover:border-indigo-500 transition-all cursor-pointer shadow-sm group">
                <h4 class="font-black text-slate-900 text-xl group-hover:text-indigo-600">Paket MULTI</h4>
                <p class="text-[10px] font-bold text-slate-400 uppercase mt-1">Team / Unlimited CS</p>
                <div class="mt-8 flex items-baseline gap-1">
                    <span class="text-3xl font-black text-indigo-600">Rp 350.000</span>
                    <span class="text-xs font-bold text-slate-400">/bulan</span>
                </div>
            </div>
        </div>

        <section id="csSection" class="hidden card-custom p-10 md:p-14 border-2 border-indigo-50">
            <h3 class="font-black text-slate-900 mb-10 uppercase tracking-[0.2em] text-sm italic text-center md:text-left">Manajemen CS</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10">
                <input type="text" id="csName" placeholder="Nama CS" class="input-field text-sm">
                <input type="email" id="csEmail" placeholder="Email CS" class="input-field text-sm">
                <input type="text" id="csPhone" placeholder="WA (628...)" class="input-field text-sm">
            </div>
            <button onclick="addCS()" class="w-full md:w-auto px-10 py-5 bg-indigo-600 text-white rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                + Tambah CS
            </button>
            <div id="csList" class="mt-10 space-y-4"></div>
        </section>
    </div>

    <script>
        const SB_URL = "https://drdilgeztsubyukexpas.supabase.co";
        const SB_KEY = "sb_publishable_7SV_sRVw9ePVjXjYHQA4_A_P42uGzWo";
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        let currentUser = null;
        let userProfile = null;

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if(!session) { window.location.href = 'auth-system.html'; return; }
            currentUser = session.user;
            document.getElementById('displayEmail').value = currentUser.email;
            await loadProfileData();
        }

        async function loadProfileData() {
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if (profile) {
                userProfile = profile;
                document.getElementById('username').value = profile.username || '';
                
                const pkg = (profile.package_type || 'TRIAL').toUpperCase();
                const badge = document.getElementById('statusBadge');
                badge.innerText = pkg + " ACCOUNT";
                badge.className = pkg === 'TRIAL' ? "px-4 py-1.5 bg-indigo-50 text-indigo-600 text-[10px] font-black rounded-full uppercase tracking-widest shadow-sm" : "px-4 py-1.5 bg-emerald-50 text-emerald-600 text-[10px] font-black rounded-full uppercase tracking-widest shadow-sm";

                if(pkg === 'MULTI') {
                    document.getElementById('csSection').classList.remove('hidden');
                    renderCS();
                } else {
                    document.getElementById('csSection').classList.add('hidden');
                }
            }
        }

        async function updateProfile() {
            const user_name = document.getElementById('username').value;
            const btn = document.getElementById('btnUpdate');
            if(!user_name) return alert("Isi username!");
            
            btn.innerText = "MENYIMPAN...";
            btn.disabled = true;

            const { error } = await supabase.from('profiles').update({ username: user_name }).eq('id', currentUser.id);

            if (!error) {
                alert("Berhasil! Username '" + user_name + "' telah disimpan.");
                btn.innerText = "SIMPAN PROFIL";
                btn.disabled = false;
            } else {
                alert("Gagal: " + error.message);
                btn.disabled = false;
            }
        }

        function renderCS() {
            const container = document.getElementById('csList');
            const csData = (userProfile.phone_numbers || []).filter(x => x.role === 'cs');
            if(csData.length === 0) {
                container.innerHTML = `<div class="p-10 text-center border-2 border-dashed border-slate-100 rounded-[2rem] font-bold text-slate-300 text-[10px] uppercase tracking-widest">Belum ada CS terdaftar</div>`;
                return;
            }
            container.innerHTML = csData.map((m, i) => `
                <div class="flex justify-between items-center p-6 bg-slate-50 rounded-[2rem] border border-slate-100 hover:bg-white hover:shadow-md transition-all">
                    <div>
                        <p class="font-black text-slate-800 text-sm">${m.name}</p>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">${m.phone} ‚Ä¢ ${m.email}</p>
                    </div>
                    <button onclick="deleteCS(${i})" class="w-10 h-10 bg-red-50 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-all flex items-center justify-center font-bold">‚úï</button>
                </div>`).join('');
        }

        async function addCS() {
            const name = document.getElementById('csName').value;
            const email = document.getElementById('csEmail').value;
            const phone = document.getElementById('csPhone').value;
            if(!name || !email || !phone) return alert("Lengkapi data CS!");
            const newList = [...(userProfile.phone_numbers || []), { name, email, phone, role: 'cs' }];
            const { error } = await supabase.from('profiles').update({ phone_numbers: newList }).eq('id', currentUser.id);
            if(!error) { userProfile.phone_numbers = newList; renderCS(); document.querySelectorAll('#csSection input').forEach(i => i.value = ''); }
        }

        async function deleteCS(index) {
            if(!confirm("Hapus CS?")) return;
            const newList = userProfile.phone_numbers.filter((_, i) => i !== index);
            const { error } = await supabase.from('profiles').update({ phone_numbers: newList }).eq('id', currentUser.id);
            if(!error) { userProfile.phone_numbers = newList; renderCS(); }
        }

        function selectPlan(p) { alert("Aktivasi Paket " + p + " dipilih!"); }

        init();
    </script>
</body>
</html>
