// Ganti fungsi init() dan tambahkan fungsi upload di dalam script dashboard-akun.html

async function init() {
    const { data: { session } } = await supabase.auth.getSession();
    if(!session) return window.location.href = 'login.html';

    const { data: profile } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
    if(profile) {
        currentUser = profile;
        document.getElementById('displayUsername').innerText = profile.username || 'User';
        document.getElementById('displayEmail').innerText = profile.email;
        document.getElementById('inputWA').value = profile.whatsapp_number || '';
        
        // Cek apakah ada Foto Profil
        const avatarBox = document.getElementById('avatarBox');
        const initials = document.getElementById('initials');
        const avatarImg = document.getElementById('avatarImg');

        if(profile.avatar_url) {
            avatarImg.src = profile.avatar_url;
            avatarImg.classList.remove('hidden');
            initials.classList.add('hidden');
        } else {
            initials.innerText = (profile.username || 'WA').substring(0,2).toUpperCase();
        }
        
        const badge = document.getElementById('badgeStatus');
        badge.innerText = (profile.package_type || 'TRIAL') + " ACCOUNT";

        if(profile.expired_at) {
            const date = new Date(profile.expired_at);
            document.getElementById('displayExpiry').innerText = date.toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });
        }
    }
}

async function uploadAvatar(input) {
    if (!input.files || input.files.length === 0) return;
    const btnSave = document.getElementById('avatarBox');
    const file = input.files[0];
    const fileExt = file.name.split('.').pop();
    const fileName = `${currentUser.id}-${Math.random()}.${fileExt}`; // Nama unik untuk menghindari cache browser

    // Loading State
    document.getElementById('initials').innerText = "‚è≥";
    document.getElementById('initials').classList.remove('hidden');
    document.getElementById('avatarImg').classList.add('hidden');

    try {
        // 1. Upload ke Storage
        const { error: uploadError } = await supabase.storage
            .from('avatars')
            .upload(fileName, file, { upsert: true });

        if (uploadError) throw uploadError;

        // 2. Ambil URL
        const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(fileName);

        // 3. Update Tabel Profiles
        const { error: updateError } = await supabase
            .from('profiles')
            .update({ avatar_url: publicUrl })
            .eq('id', currentUser.id);

        if (updateError) throw updateError;

        // Berhasil
        location.reload(); // Refresh untuk melihat hasil
    } catch (err) {
        alert("Gagal upload: " + err.message);
        init(); // Reset tampilan
    }
}
