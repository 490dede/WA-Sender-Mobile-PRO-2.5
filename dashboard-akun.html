<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Akun - WA-Sender PRO 2.5</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-4xl mx-auto space-y-8">
        <header class="flex justify-between items-center bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
            <div>
                <h1 class="text-xl font-black text-slate-900">WA-Sender PRO 2.5</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="statusBadge" class="px-3 py-1 bg-indigo-50 text-indigo-600 text-[10px] font-black rounded-full uppercase transition-colors duration-500">TRIAL</span>
                </div>
            </div>
            <a href="delivery-chat.html" class="w-12 h-12 bg-slate-900 text-white rounded-2xl flex items-center justify-center text-xl hover:scale-110 transition-all shadow-lg">üè†</a>
        </header>

        <section class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100">
            <h3 class="font-black text-slate-800 mb-8 uppercase tracking-widest text-sm">Informasi Akun</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Username</label>
                    <input type="text" id="username" placeholder="Buat Username" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-indigo-500 font-bold mt-2 transition-all">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Email (Terkunci)</label>
                    <input type="text" id="displayEmail" disabled class="w-full p-4 bg-slate-100 border border-slate-100 rounded-2xl font-bold mt-2 text-slate-500">
                </div>
            </div>
            <button onclick="updateProfile()" id="btnUpdate" class="mt-8 px-10 py-4 bg-slate-900 text-white rounded-2xl font-black uppercase text-xs shadow-xl active:scale-95 transition-all disabled:opacity-50">Simpan Profil</button>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div onclick="selectPlan('PRO')" class="bg-white p-8 rounded-[2.5rem] border border-slate-100 cursor-pointer hover:border-indigo-500 transition-all group">
                <h4 class="font-black text-slate-900 group-hover:text-indigo-600">Paket PRO</h4>
                <p class="text-[10px] font-bold text-slate-400 uppercase">Single User / Perorangan</p>
                <p class="mt-4 text-xl font-black text-indigo-600">Rp 150.000 <span class="text-xs text-slate-400">/bulan</span></p>
            </div>
            <div onclick="selectPlan('MULTI')" class="bg-white p-8 rounded-[2.5rem] border border-slate-100 cursor-pointer hover:border-indigo-500 transition-all group">
                <h4 class="font-black text-slate-900 group-hover:text-indigo-600">Paket MULTI</h4>
                <p class="text-[10px] font-bold text-slate-400 uppercase">Team / Unlimited CS</p>
                <p class="mt-4 text-xl font-black text-indigo-600">Rp 350.000 <span class="text-xs text-slate-400">/bulan</span></p>
            </div>
        </div>

        <section id="csSection" class="hidden animate-fade-in bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100">
            <h3 class="font-black text-slate-800 mb-8 uppercase tracking-widest text-sm">Manajemen Pasukan CS</h3>
            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <input type="text" id="csName" placeholder="Nama CS" class="flex-1 p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-indigo-500">
                <input type="email" id="csEmail" placeholder="Email CS" class="flex-1 p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-indigo-500">
                <input type="text" id="csPhone" placeholder="Nomor WA (62...)" class="flex-1 p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:border-indigo-500">
                <button onclick="addCS()" class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black uppercase text-[10px] active:scale-95 transition-all shadow-lg">+ Tambah</button>
            </div>
            <div id="csList" class="space-y-4"></div>
        </section>
    </div>

    <script>
        const SB_URL = "https://drdilgeztsubyukexpas.supabase.co";
        const SB_KEY = "sb_publishable_7SV_sRVw9ePVjXjYHQA4_A_P42uGzWo";
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        let currentUser = null;
        let userProfile = null;

        const pricing = {
            'PRO': { name: 'PRO', price: 'Rp 150.000', qrCode: 'https://via.placeholder.com/300?text=QRIS+PRO' },
            'MULTI': { name: 'MULTI USER', price: 'Rp 350.000', qrCode: 'https://via.placeholder.com/300?text=QRIS+MULTI' }
        };

        // INISIALISASI
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if(!session) { window.location.href = 'auth-system.html'; return; }
            
            currentUser = session.user;
            document.getElementById('displayEmail').value = currentUser.email;

            await loadProfileData();
        }

        // LOAD DATA TANPA REFRESH HALAMAN
        async function loadProfileData() {
            const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            
            if (profile) {
                userProfile = profile;
                document.getElementById('username').value = profile.username || '';
                
                // Pastikan penamaan paket bersih (TRIAL, PRO, atau MULTI)
                const pkg = profile.package_type ? profile.package_type.toUpperCase() : 'TRIAL';
                const badge = document.getElementById('statusBadge');
                badge.innerText = pkg;

                // Update Style Badge berdasarkan Paket
                if (pkg === 'TRIAL') {
                    badge.className = "px-3 py-1 bg-indigo-50 text-indigo-600 text-[10px] font-black rounded-full uppercase";
                } else {
                    badge.className = "px-3 py-1 bg-emerald-50 text-emerald-600 text-[10px] font-black rounded-full uppercase";
                }

                // Logika Tampilan Section CS
                const csSection = document.getElementById('csSection');
                if(pkg.includes('MULTI')) {
                    csSection.classList.remove('hidden');
                    renderCS();
                } else {
                    csSection.classList.add('hidden');
                }
            }
        }

        // UPDATE PROFIL (REAL-TIME TANPA REFRESH)
        async function updateProfile() {
            const user_name = document.getElementById('username').value;
            const btn = document.getElementById('btnUpdate');
            
            if(!user_name) return alert("Username wajib diisi!");
            
            btn.innerText = "MENYIMPAN...";
            btn.disabled = true;

            const { error } = await supabase.from('profiles').update({ username: user_name }).eq('id', currentUser.id);

            if (!error) {
                // Feedback Visual Berhasil
                btn.innerText = "BERHASIL DISIMPAN! ‚úÖ";
                btn.classList.replace('bg-slate-900', 'bg-emerald-600');
                
                // Update lokal variabel
                userProfile.username = user_name;

                // Kembalikan tombol ke status normal setelah 2 detik
                setTimeout(() => {
                    btn.innerText = "SIMPAN PROFIL";
                    btn.classList.replace('bg-emerald-600', 'bg-slate-900');
                    btn.disabled = false;
                }, 2000);
            } else {
                alert("Gagal menyimpan: " + error.message);
                btn.innerText = "SIMPAN PROFIL";
                btn.disabled = false;
            }
        }

        // SISTEM PEMBAYARAN
        function selectPlan(planKey) {
            const plan = pricing[planKey];
            const paymentArea = `
                <div id="paymentModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-6 text-center animate-fade-in">
                    <div class="bg-white max-w-sm w-full rounded-[3rem] p-10 relative shadow-2xl">
                        <button onclick="document.getElementById('paymentModal').remove()" class="absolute right-6 top-6 text-slate-300 hover:text-red-500 text-xl transition-colors">‚úï</button>
                        <h2 class="font-black text-xl mb-2 text-slate-900">Aktivasi Paket ${plan.name}</h2>
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-6 tracking-widest">Scan QRIS Untuk Melanjutkan</p>
                        <div class="bg-slate-50 p-4 rounded-3xl mb-6 border border-slate-100">
                            <img src="${plan.qrCode}" class="w-full rounded-2xl border-4 border-white shadow-sm">
                            <p class="mt-4 font-black text-2xl text-indigo-600">${plan.price}</p>
                        </div>
                        <button onclick="confirmPayment('${planKey}')" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black uppercase text-xs shadow-xl active:scale-95 transition-all">Saya Sudah Bayar</button>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', paymentArea);
        }

        async function confirmPayment(planKey) {
            alert("Terima kasih! Admin akan melakukan validasi dan mengaktifkan paket Anda.");
            document.getElementById('paymentModal').remove();
            await supabase.from('message_logs').insert([{ user_id: currentUser.id, pesan: `REQ_AKTIVASI: ${planKey}` }]);
        }

        // MANAJEMEN CS (REAL-TIME)
        function renderCS() {
            const container = document.getElementById('csList');
            const list = userProfile.phone_numbers || [];
            const csData = list.filter(x => x.role === 'cs');

            if(csData.length === 0) {
                container.innerHTML = `<p class="text-center text-[10px] font-bold text-slate-300 uppercase py-8 border-2 border-dashed border-slate-50 rounded-3xl">Belum ada Pasukan CS terdaftar</p>`;
                return;
            }

            container.innerHTML = csData.map((m, i) => `
                <div class="flex justify-between items-center p-5 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-white hover:shadow-md transition-all">
                    <div>
                        <p class="font-black text-slate-800 text-sm">${m.name}</p>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tight">${m.phone} ‚Ä¢ ${m.email}</p>
                    </div>
                    <button onclick="deleteCS(${i})" class="w-10 h-10 flex items-center justify-center bg-white text-red-500 rounded-xl border border-red-50 hover:bg-red-50 transition-all shadow-sm">üóëÔ∏è</button>
                </div>`).join('');
        }

        async function addCS() {
            const name = document.getElementById('csName').value;
            const email = document.getElementById('csEmail').value;
            const phone = document.getElementById('csPhone').value;
            
            if(!name || !email || !phone) return alert("Mohon lengkapi semua kolom CS!");

            const newList = [...(userProfile.phone_numbers || []), { name, email, phone, role: 'cs' }];
            
            const { error } = await supabase.from('profiles').update({ phone_numbers: newList }).eq('id', currentUser.id);
            
            if(!error) {
                userProfile.phone_numbers = newList; // Update local state
                renderCS(); // Render ulang list
                // Bersihkan input
                document.getElementById('csName').value = '';
                document.getElementById('csEmail').value = '';
                document.getElementById('csPhone').value = '';
            } else {
                alert("Gagal menambah CS: " + error.message);
            }
        }

        async function deleteCS(index) {
            if(!confirm("Hapus CS ini dari pasukan Anda?")) return;
            
            const currentList = userProfile.phone_numbers || [];
            const newList = currentList.filter((_, i) => i !== index);
            
            const { error } = await supabase.from('profiles').update({ phone_numbers: newList }).eq('id', currentUser.id);
            
            if(!error) {
                userProfile.phone_numbers = newList;
                renderCS();
            }
        }

        // Jalankan Inisialisasi
        init();
    </script>
</body>
</html>
