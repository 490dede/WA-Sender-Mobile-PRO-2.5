<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Scraper v2.5 - WA-Sender PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0F172A; color: #F1F5F9; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .input-glow:focus { border-color: #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.2); outline: none; }
        .custom-loader { width: 20px; height: 20px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-10 bg-slate-950 min-h-screen text-sharp">

    <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-12">
            <div>
                <a href="dashboard-user.html" class="text-purple-400 text-[10px] font-black uppercase tracking-[0.2em] hover:text-white transition-all">
                    <i class="fa-solid fa-arrow-left mr-2"></i> Back to Command Center
                </a>
                <h1 class="text-4xl font-black italic uppercase tracking-tighter text-white mt-4">LEAD <span class="text-purple-500">SCRAPER</span></h1>
            </div>
            <div class="glass-card px-6 py-3 rounded-2xl border-white/10">
                <p class="text-[9px] font-black text-slate-500 uppercase italic tracking-widest">Targeting: <span class="text-emerald-400">Global Search</span></p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="glass-card p-6 rounded-[2rem] border-white/5">
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 italic">Niche / Keyword</label>
                    <input type="text" id="keyword" placeholder="Contoh: Real Estate" class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm text-white input-glow mb-6">
                    
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 italic">Target Region</label>
                    <select id="region" class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm text-white mb-6 outline-none">
                        <option>Loading regions...</option>
                    </select>

                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 italic">Platform</label>
                    <select id="platform" class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm text-white mb-8 outline-none">
                        <option>Loading platforms...</option>
                    </select>

                    <button onclick="startScraping()" id="btn-scrape" class="w-full py-4 bg-purple-600 hover:bg-purple-500 rounded-xl font-black uppercase text-[10px] tracking-widest transition-all shadow-xl shadow-purple-500/20">
                        Search Global Leads
                    </button>
                </div>

                <div class="glass-card p-6 rounded-[2rem] border-white/5 text-center">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">My Total Leads Scraped</p>
                    <p id="total-count" class="text-4xl font-black text-purple-400 italic">0</p>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="glass-card rounded-[2.5rem] border-white/5 overflow-hidden">
                    <div class="p-8 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
                        <h3 class="text-xs font-black uppercase tracking-widest text-white">Results Found (Simulated)</h3>
                        <div class="flex gap-3">
                            <button onclick="pushToSender()" class="bg-indigo-600 hover:bg-indigo-500 text-white text-[9px] font-black px-4 py-2 rounded-full uppercase transition-all shadow-lg shadow-indigo-500/20">
                                <i class="fa-solid fa-paper-plane mr-1"></i> Push to Sender
                            </button>
                            <button onclick="copyResults()" class="text-[9px] font-black text-slate-400 hover:text-white uppercase transition-colors px-4 py-2">
                                <i class="fa-solid fa-copy mr-1"></i> Copy
                            </button>
                        </div>
                    </div>
                    <div class="max-h-[500px] overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="text-[10px] font-black text-slate-600 uppercase tracking-tighter border-b border-white/5 sticky top-0 bg-slate-900/90 backdrop-blur-md">
                                <tr>
                                    <th class="p-6">WhatsApp Number</th>
                                    <th class="p-6">Source Detail</th>
                                </tr>
                            </thead>
                            <tbody id="result-body" class="text-sm text-slate-400">
                                <tr>
                                    <td colspan="2" class="p-20 text-center text-xs italic text-slate-600 uppercase font-bold tracking-[0.3em]">Ready to scan...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://xitvmryrzeiinlcgdrfj.supabase.co";
        const SB_KEY = "sb_publishable_DLbeS1UUi5tjY51yRy6VkA_unJMJFbk";
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        async function init() {
            await Promise.all([loadRegions(), loadPlatforms(), updateCounter()]);
        }

        async function loadRegions() {
            const { data } = await supabase.from('region_codes').select('*').order('region_name');
            if(data) {
                document.getElementById('region').innerHTML = data.map(r => `<option value="${r.phone_code}">${r.region_name} (+${r.phone_code})</option>`).join('');
            }
        }

        async function loadPlatforms() {
            const { data } = await supabase.from('scraper_platforms').select('*').order('platform_name');
            if(data) {
                document.getElementById('platform').innerHTML = data.map(p => `<option value="${p.platform_name.toLowerCase()}.com">${p.platform_name}</option>`).join('');
            }
        }

        async function updateCounter() {
            const { data: { session } } = await supabase.auth.getSession();
            if(session) {
                const { data } = await supabase.from('profiles').select('leads_generated').eq('id', session.user.id).single();
                document.getElementById('total-count').innerText = data?.leads_generated || 0;
            }
        }

        async function startScraping() {
            const keyword = document.getElementById('keyword').value;
            const platform = document.getElementById('platform').value;
            const region = document.getElementById('region').value;
            if (!keyword) return alert("Masukkan kata kunci!");

            const btn = document.getElementById('btn-scrape');
            btn.disabled = true;
            btn.innerHTML = `<span class="custom-loader mr-2"></span> Scanning...`;

            // Dorking Action
            const query = `site:${platform} "${keyword}" "${region}"`;
            window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');

            // Generate Mock Data for User
            setTimeout(async () => {
                const tbody = document.getElementById('result-body');
                tbody.innerHTML = ''; 
                for(let i=0; i<8; i++) {
                    const randomNum = Math.floor(1000000 + Math.random() * 9000000);
                    const finalNum = `${region}${randomNum}`;
                    tbody.innerHTML += `
                        <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors">
                            <td class="p-6 font-bold text-white tracking-wider">${finalNum}</td>
                            <td class="p-6 text-[10px] uppercase text-slate-500 italic">${platform} | ${keyword}</td>
                        </tr>`;
                }
                const { data: { session } } = await supabase.auth.getSession();
                if(session) {
                    const { data } = await supabase.from('profiles').select('leads_generated').eq('id', session.user.id).single();
                    await supabase.from('profiles').update({ leads_generated: (data?.leads_generated || 0) + 8 }).eq('id', session.user.id);
                    updateCounter();
                }
                btn.disabled = false; btn.innerHTML = `Search Global Leads`;
            }, 2000);
        }

        function pushToSender() {
            const numbers = Array.from(document.querySelectorAll("#result-body td:first-child")).map(td => td.innerText).filter(n => !n.includes("Ready"));
            if (numbers.length === 0) return alert("Kosong!");
            localStorage.setItem('scrapedLeads', numbers.join('\n'));
            alert("Nomor dipindahkan ke Bulk Sender!");
            window.location.href = "bulk-sender.html";
        }

        init();
    </script>
</body>
</html>
