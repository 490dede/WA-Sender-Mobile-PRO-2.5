// Pastikan bagian pengecekan admin tetap mengunci ke email Anda
async function checkAdmin() {
    const { data: { session } } = await supabase.auth.getSession();
    
    // Proteksi Berlapis: Cek sesi dan cek email spesifik Anda
    if (!session || session.user.email !== 'adeali490@gmail.com') {
        alert("ACCESS DENIED / AKSES DITOLAK!");
        window.location.href = 'dashboard-user.html';
        return;
    }
    fetchUsers();
}

// Tambahkan logika untuk menampilkan avatar kecil di tabel (opsional tapi keren)
async function fetchUsers() {
    const { data: users, error } = await supabase
        .from('profiles')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) return console.error(error);

    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = '';

    users.forEach(user => {
        const expiryDate = user.expired_at ? new Date(user.expired_at).toLocaleDateString('id-ID') : 'N/A';
        
        // Logika tampilan avatar di tabel admin
        const avatarDisplay = user.avatar_url 
            ? `<img src="${user.avatar_url}" class="w-8 h-8 rounded-lg object-cover">`
            : `<div class="w-8 h-8 bg-slate-700 rounded-lg flex items-center justify-center text-[10px] font-black">${(user.username || 'U').substring(0,1)}</div>`;

        const row = `
            <tr class="hover:bg-white/5 transition-all">
                <td class="px-8 py-4 flex items-center gap-3">
                    ${avatarDisplay}
                    <div>
                        <div class="font-black italic text-white uppercase text-[12px]">${user.username}</div>
                        <div class="text-[9px] text-slate-500">${user.email}</div>
                    </div>
                </td>
                <td class="px-8 py-4 font-mono text-slate-400 text-[10px]">${user.whatsapp_number || '-'}</td>
                <td class="px-8 py-4">
                    <span class="px-2 py-0.5 rounded-md text-[8px] font-black italic ${user.package_type === 'TRIAL' ? 'bg-orange-500/10 text-orange-500 border border-orange-500/20' : 'bg-emerald-500/10 text-emerald-500 border border-emerald-500/20'}">
                        ${user.package_type}
                    </span>
                </td>
                <td class="px-8 py-4 text-[10px] text-slate-400 italic">${expiryDate}</td>
                <td class="px-8 py-4 text-right">
                    <div class="flex justify-end gap-2">
                        <button onclick="updatePackage('${user.id}', 'PRO')" class="px-3 py-1 bg-indigo-600 rounded-md text-[8px] font-black uppercase hover:bg-indigo-500 transition-all">SET PRO</button>
                        <button onclick="updatePackage('${user.id}', 'MULTI')" class="px-3 py-1 bg-purple-600 rounded-md text-[8px] font-black uppercase hover:bg-purple-500 transition-all">SET MULTI</button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}
